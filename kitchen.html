<!DOCTYPE html>
<html>
<head>
  <title>Kitchen Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ff9800">
</head>

<body>

<h2>üç≥ Kitchen Panel</h2>
<button onclick="logout()">Logout</button>

<div id="orders">Checking login...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCgaZ9DqGuszvycCRuJceNvg7G86OTc9oU",
  authDomain: "restaurant-55333.firebaseapp.com",
  projectId: "restaurant-55333"
};

/* INIT */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const ordersDiv = document.getElementById("orders");

/* üîê LOGIN GUARD ‚Äî MOST IMPORTANT PART */
onAuthStateChanged(auth, (user) => {
  if (!user) {
    // ‚ùå Not logged in ‚Üí redirect
    window.location.replace("login.html");
    return;
  }

  // ‚úÖ Logged in ‚Üí load orders
  loadOrders();
});

/* üî• LOAD ORDERS (ONLY AFTER LOGIN) */
function loadOrders() {
  ordersDiv.innerHTML = "Loading orders...";

  onSnapshot(collection(db, "orders"), (snapshot) => {
    ordersDiv.innerHTML = "";

    if (snapshot.empty) {
      ordersDiv.innerHTML = "<p>No orders yet</p>";
      return;
    }

    snapshot.forEach((docSnap) => {
      const o = docSnap.data();

      ordersDiv.innerHTML += `
        <div style="border:1px solid #000; margin:10px; padding:10px">
          <b>Name:</b> ${o.customerName}<br>
          <b>Table:</b> ${o.tableNumber}<br>
          <b>Items:</b> ${o.items.map(i => i.name).join(", ")}<br>
          <b>Status:</b> ${o.status}<br><br>

          <button onclick="setStatus('${docSnap.id}','preparing',10)">
            Preparing (10 min)
          </button>

          <button onclick="setStatus('${docSnap.id}','ready',0)">
            Ready
          </button>
        </div>
      `;
    });
  });
}

/* üîÑ UPDATE STATUS */
window.setStatus = async (id, status, time) => {
  await updateDoc(doc(db, "orders", id), {
    status: status,
    readyTime: time
  });
};

/* üîì LOGOUT */
window.logout = () => {
  signOut(auth).then(() => {
    window.location.replace("login.html");
  });
};
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
